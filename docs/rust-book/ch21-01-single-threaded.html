<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Budowanie jednowątkowego serwera WWW - Język programowania Rust</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="ferris-d33b75bf.css">
        <link rel="stylesheet" href="theme/2018-edition-4e126c62.css">
        <link rel="stylesheet" href="theme/semantic-notes-9b5766c0.css">
        <link rel="stylesheet" href="theme/listing-cab26221.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-773dca2f.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-039e37ba.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Język programowania Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/book" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h2 id="budowanie-jednowątkowego-serwera-www"><a class="header" href="#budowanie-jednowątkowego-serwera-www">Budowanie jednowątkowego serwera WWW</a></h2>
<p>Zaczniemy od uruchomienia jednowątkowego serwera WWW. Zanim zaczniemy, spójrzmy na szybki przegląd protokołów zaangażowanych w budowanie serwerów WWW. Szczegóły tych protokołów wykraczają poza zakres tej książki, ale krótki przegląd dostarczy ci niezbędnych informacji.</p>
<p>Dwa główne protokoły zaangażowane w serwery WWW to <em>Hypertext Transfer Protocol</em> <em>(HTTP)</em> i <em>Transmission Control Protocol</em> <em>(TCP)</em>. Oba protokoły są protokołami typu <em>żądanie-odpowiedź</em>, co oznacza, że <em>klient</em> inicjuje żądania, a <em>serwer</em> nasłuchuje żądań i dostarcza klientowi odpowiedź. Zawartość tych żądań i odpowiedzi jest definiowana przez protokoły.</p>
<p>TCP to protokół niższego poziomu, który opisuje szczegóły, jak informacje trafiają z jednego serwera do drugiego, ale nie precyzuje, czym są te informacje. HTTP buduje na TCP, definiując zawartość żądań i odpowiedzi. Technicznie możliwe jest używanie HTTP z innymi protokołami, ale w zdecydowanej większości przypadków HTTP wysyła swoje dane przez TCP. Będziemy pracować z surowymi bajtami żądań i odpowiedzi TCP i HTTP.</p>
<h3 id="nasłuchiwanie-połączeń-tcp"><a class="header" href="#nasłuchiwanie-połączeń-tcp">Nasłuchiwanie połączeń TCP</a></h3>
<p>Nasz serwer WWW musi nasłuchiwać połączeń TCP, więc to jest pierwsza część, nad którą będziemy pracować. Biblioteka standardowa oferuje moduł <code>std::net</code>, który nam to umożliwia. Stwórzmy nowy projekt w zwykły sposób:</p>
<pre><code class="language-console">$ cargo new hello
     Utworzono projekt binarny (aplikacja) `hello`
$ cd hello
</code></pre>
<p>Teraz wprowadź kod z Listingu 21-1 do <em>src/main.rs</em>, aby rozpocząć. Ten kod będzie nasłuchiwał przy lokalnym adresie <code>127.0.0.1:7878</code> na przychodzące strumienie TCP. Kiedy otrzyma przychodzący strumień, wydrukuje <code>Connection established!</code>.</p>
<listing number="21-1" file-name="src/main.rs" caption="Nasłuchiwanie przychodzących strumieni i wyświetlanie komunikatu po odebraniu strumienia">
<pre class="playground"><code class="language-rust no_run edition2024">use std::net::TcpListener;

fn main() {
    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();

    for stream in listener.incoming() {
        let stream = stream.unwrap();

        println!("Connection established!");
    }
}</code></pre>
</listing>
<p>Używając <code>TcpListener</code>, możemy nasłuchiwać połączeń TCP pod adresem <code>127.0.0.1:7878</code>. W adresie, sekcja przed dwukropkiem to adres IP reprezentujący twój komputer (jest taki sam na każdym komputerze i nie reprezentuje konkretnie komputera autorów), a <code>7878</code> to port. Wybraliśmy ten port z dwóch powodów: HTTP nie jest zwykle akceptowany na tym porcie, więc nasz serwer raczej nie będzie kolidował z żadnym innym serwerem WWW, który możesz mieć uruchomiony na swojej maszynie, a 7878 to <em>rust</em> wpisane na telefonie.</p>
<p>Funkcja <code>bind</code> w tym scenariuszu działa jak funkcja <code>new</code> w tym sensie, że zwróci nową instancję <code>TcpListener</code>. Funkcja nazywa się <code>bind</code>, ponieważ w sieciach połączenie z portem w celu nasłuchiwania jest znane jako „wiązanie się z portem”.</p>
<p>Funkcja <code>bind</code> zwraca <code>Result&lt;T, E&gt;</code>, co wskazuje, że wiązanie może się nie powieść, na przykład, gdybyśmy uruchomili dwie instancje naszego programu i tym samym mieli dwa programy nasłuchujące na tym samym porcie. Ponieważ piszemy podstawowy serwer wyłącznie w celach edukacyjnych, nie będziemy martwić się o obsługę tego typu błędów; zamiast tego używamy <code>unwrap</code>, aby zatrzymać program, jeśli wystąpią błędy.</p>
<p>Metoda <code>incoming</code> na <code>TcpListener</code> zwraca iterator, który dostarcza nam sekwencję strumieni (dokładniej, strumieni typu <code>TcpStream</code>). Pojedynczy <em>strumień</em> reprezentuje otwarte połączenie między klientem a serwerem. <em>Połączenie</em> to nazwa pełnego procesu żądanie-odpowiedź, w którym klient łączy się z serwerem, serwer generuje odpowiedź i serwer zamyka połączenie. W związku z tym będziemy czytać z <code>TcpStream</code>, aby zobaczyć, co klient wysłał, a następnie zapiszemy naszą odpowiedź do strumienia, aby wysłać dane z powrotem do klienta. Ogólnie rzecz biorąc, ta pętla <code>for</code> będzie przetwarzać każde połączenie po kolei i generować serię strumieni, które będziemy obsługiwać.</p>
<p>Na razie nasza obsługa strumienia polega na wywołaniu <code>unwrap</code>, aby zakończyć program, jeśli strumień ma jakieś błędy; jeśli błędów nie ma, program wyświetla komunikat. W następnym listingu dodamy więcej funkcjonalności dla przypadku sukcesu. Powodem, dla którego możemy otrzymać błędy z metody <code>incoming</code>, gdy klient łączy się z serwerem, jest to, że nie iterujemy faktycznie po połączeniach. Zamiast tego iterujemy po <em>próbach połączenia</em>. Połączenie może się nie powieść z wielu powodów, z których wiele jest specyficznych dla systemu operacyjnego. Na przykład, wiele systemów operacyjnych ma limit liczby jednoczesnych otwartych połączeń, które mogą obsługiwać; nowe próby połączenia powyżej tej liczby będą generować błąd, dopóki niektóre z otwartych połączeń nie zostaną zamknięte.</p>
<p>Spróbujmy uruchomić ten kod! Wywołaj <code>cargo run</code> w terminalu, a następnie załaduj <em>127.0.0.1:7878</em> w przeglądarce internetowej. Przeglądarka powinna wyświetlić komunikat o błędzie, taki jak „Connection reset”, ponieważ serwer obecnie nie wysyła żadnych danych. Ale kiedy spojrzysz na swój terminal, powinieneś zobaczyć kilka komunikatów, które zostały wydrukowane, gdy przeglądarka połączyła się z serwerem!</p>
<pre><code class="language-text">     Uruchamianie `target/debug/hello`
Połączenie nawiązane!
Połączenie nawiązane!
Połączenie nawiązane!
</code></pre>
<p>Czasami zobaczysz wiele komunikatów wydrukowanych dla jednego żądania przeglądarki; powodem może być to, że przeglądarka wysyła żądanie o stronę, a także żądanie o inne zasoby, takie jak ikona <em>favicon.ico</em>, która pojawia się w zakładce przeglądarki.</p>
<p>Może się również zdarzyć, że przeglądarka próbuje połączyć się z serwerem wielokrotnie, ponieważ serwer nie odpowiada żadnymi danymi. Gdy <code>stream</code> wychodzi poza zakres i jest porzucony na końcu pętli, połączenie jest zamykane w ramach implementacji <code>drop</code>. Przeglądarki czasami radzą sobie z zamkniętymi połączeniami, ponawiając próbę, ponieważ problem może być tymczasowy.</p>
<p>Przeglądarki czasami otwierają również wiele połączeń z serwerem bez wysyłania żadnych żądań, aby w przypadku późniejszego wysłania żądań, te żądania mogły nastąpić szybciej. Kiedy to nastąpi, nasz serwer zobaczy każde połączenie, niezależnie od tego, czy istnieją jakiekolwiek żądania przez to połączenie. Robi tak wiele wersji przeglądarek opartych na Chrome, na przykład; możesz wyłączyć tę optymalizację, używając trybu przeglądania prywatnego lub innej przeglądarki.</p>
<p>Ważnym czynnikiem jest to, że z powodzeniem uzyskaliśmy uchwyt do połączenia TCP!</p>
<p>Pamiętaj, aby zatrzymać program, naciskając <kbd>ctrl</kbd>-<kbd>C</kbd>, gdy skończysz uruchamiać określoną wersję kodu. Następnie uruchom program ponownie, wywołując polecenie <code>cargo run</code> po wprowadzeniu każdej serii zmian w kodzie, aby upewnić się, że uruchamiasz najnowszy kod.</p>
<h3 id="odczytywanie-żądania"><a class="header" href="#odczytywanie-żądania">Odczytywanie żądania</a></h3>
<p>Zaimplementujmy funkcjonalność do odczytywania żądania z przeglądarki! Aby oddzielić kwestie nawiązania połączenia od wykonania jakiejś akcji z nim związanej, rozpoczniemy nową funkcję do przetwarzania połączeń. W tej nowej funkcji <code>handle_connection</code> będziemy czytać dane ze strumienia TCP i drukować je, abyśmy mogli zobaczyć dane wysyłane z przeglądarki. Zmień kod, aby wyglądał jak na Listingu 21-2.</p>
<listing number="21-2" file-name="src/main.rs" caption="Odczytywanie ze strumienia `TcpStream` i drukowanie danych">
<pre class="playground"><code class="language-rust no_run edition2024">use std::{
    io::{BufReader, prelude::*},
    net::{TcpListener, TcpStream},
};

fn main() {
    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();

    for stream in listener.incoming() {
        let stream = stream.unwrap();

        handle_connection(stream);
    }
}

fn handle_connection(mut stream: TcpStream) {
    let buf_reader = BufReader::new(&amp;stream);
    let http_request: Vec&lt;_&gt; = buf_reader
        .lines()
        .map(|result| result.unwrap())
        .take_while(|line| !line.is_empty())
        .collect();

    println!("Żądanie: {http_request:#?}");
}</code></pre>
</listing>
<p>Wprowadzamy <code>std::io::BufReader</code> i <code>std::io::prelude</code> do zakresu, aby uzyskać dostęp do cech i typów, które pozwalają nam czytać i zapisywać do strumienia. W pętli <code>for</code> w funkcji <code>main</code>, zamiast wyświetlać komunikat informujący o nawiązaniu połączenia, wywołujemy teraz nową funkcję <code>handle_connection</code> i przekazujemy jej <code>stream</code>.</p>
<p>W funkcji <code>handle_connection</code> tworzymy nową instancję <code>BufReader</code>, która opakowuje referencję do <code>stream</code>. <code>BufReader</code> dodaje buforowanie, zarządzając za nas wywołaniami metod cechy <code>std::io::Read</code>.</p>
<p>Tworzymy zmienną o nazwie <code>http_request</code>, aby zbierać linie żądania, które przeglądarka wysyła do naszego serwera. Wskazujemy, że chcemy zebrać te linie w wektorze, dodając adnotację typu <code>Vec&lt;_&gt;</code>.</p>
<p><code>BufReader</code> implementuje cechę <code>std::io::BufRead</code>, która dostarcza metodę <code>lines</code>. Metoda <code>lines</code> zwraca iterator <code>Result&lt;String, std::io::Error&gt;</code>, dzieląc strumień danych za każdym razem, gdy zobaczy znak nowej linii. Aby uzyskać każdy <code>String</code>, <code>map</code>ujemy i <code>unwrap</code>ujemy każdy <code>Result</code>. <code>Result</code> może być błędem, jeśli dane nie są prawidłowym UTF-8 lub jeśli wystąpił problem podczas czytania ze strumienia. Ponownie, program produkcyjny powinien obsługiwać te błędy bardziej elegancko, ale my decydujemy się na zatrzymanie programu w przypadku błędu dla uproszczenia.</p>
<p>Przeglądarka sygnalizuje koniec żądania HTTP, wysyłając dwa znaki nowej linii z rzędu, więc aby uzyskać jedno żądanie ze strumienia, pobieramy linie, dopóki nie otrzymamy linii, która jest pustym ciągiem znaków. Po zebraniu linii do wektora, drukujemy je, używając ładnego formatowania debugowania, abyśmy mogli przyjrzeć się instrukcjom, które przeglądarka internetowa wysyła do naszego serwera.</p>
<p>Spróbujmy tego kodu! Uruchom program i ponownie wyślij żądanie w przeglądarce internetowej. Zauważ, że nadal otrzymamy stronę błędu w przeglądarce, ale wynik naszego programu w terminalu będzie teraz wyglądał podobnie do tego:</p>
<!-- manual-regeneration
cd listings/ch21-web-server/listing-21-02
cargo run
wyślij żądanie na 127.0.0.1:7878
Nie można zautomatyzować, ponieważ wynik zależy od wysyłania żądań
-->
<pre><code class="language-console">$ cargo run
   Kompilowanie hello v0.1.0 (file:///projects/hello)
    Zakończono `dev` profil [nieoptymalny + debuginfo] cel(e) w 0.42s
     Uruchamianie `target/debug/hello`
Żądanie: [
    "GET / HTTP/1.1",
    "Host: 127.0.0.1:7878",
    "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:99.0) Gecko/20100101 Firefox/99.0",
    "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
    "Accept-Language: en-US,en;q=0.5",
    "Accept-Encoding: gzip, deflate, br",
    "DNT: 1",
    "Connection: keep-alive",
    "Upgrade-Insecure-Requests: 1",
    "Sec-Fetch-Dest: document",
    "Sec-Fetch-Mode: navigate",
    "Sec-Fetch-Site: none",
    "Sec-Fetch-User: ?1",
    "Cache-Control: max-age=0",
]
</code></pre>
<p>W zależności od przeglądarki, możesz otrzymać nieco inny wynik. Teraz, gdy drukujemy dane żądania, możemy zobaczyć, dlaczego otrzymujemy wiele połączeń z jednego żądania przeglądarki, patrząc na ścieżkę po <code>GET</code> w pierwszej linii żądania. Jeśli powtarzające się połączenia wszystkie żądają <em>/</em>, wiemy, że przeglądarka próbuje wielokrotnie pobrać <em>/</em>, ponieważ nie otrzymuje odpowiedzi z naszego programu.</p>
<p>Przeanalizujmy te dane żądania, aby zrozumieć, o co przeglądarka prosi nasz program.</p>
<!-- Old headings. Do not remove or links may break. -->
<p><a id="a-closer-look-at-an-http-request"></a>
<a id="looking-closer-at-an-http-request"></a></p>
<h3 id="bliższe-spojrzenie-na-żądanie-http"><a class="header" href="#bliższe-spojrzenie-na-żądanie-http">Bliższe spojrzenie na żądanie HTTP</a></h3>
<p>HTTP to protokół tekstowy, a żądanie ma następujący format:</p>
<pre><code class="language-text">Metoda Identyfikator-żądania Wersja-HTTP CRLF
nagłówki CRLF
ciało-wiadomości
</code></pre>
<p>Pierwsza linia to <em>linia żądania</em>, która zawiera informacje o tym, czego klient żąda. Pierwsza część linii żądania wskazuje używaną metodę, taką jak <code>GET</code> lub <code>POST</code>, która opisuje, w jaki sposób klient wysyła to żądanie. Nasz klient użył żądania <code>GET</code>, co oznacza, że prosi o informacje.</p>
<p>Następną częścią linii żądania jest <em>/</em>, która wskazuje <em>uniform resource identifier</em> <em>(URI)</em>, o który prosi klient: URI jest prawie, ale niezupełnie, tym samym co <em>uniform resource locator</em> <em>(URL)</em>. Różnica między URI a URL nie jest istotna dla naszych celów w tym rozdziale, ale specyfikacja HTTP używa terminu <em>URI</em>, więc możemy tutaj po prostu mentalnie zastąpić <em>URL</em> przez <em>URI</em>.</p>
<p>Ostatnią częścią jest wersja HTTP używana przez klienta, a następnie linia żądania kończy się sekwencją CRLF. (CRLF to skrót od <em>carriage return</em> i <em>line feed</em>, co są terminami z czasów maszyn do pisania!) Sekwencję CRLF można również zapisać jako <code>\r\n</code>, gdzie <code>\r</code> to znak powrotu karetki, a <code>\n</code> to znak nowej linii. <em>Sekwencja CRLF</em> oddziela linię żądania od reszty danych żądania. Zauważ, że gdy CRLF jest drukowane, widzimy początek nowej linii, a nie <code>\r\n</code>.</p>
<p>Patrząc na dane linii żądania, które otrzymaliśmy po uruchomieniu naszego programu, widzimy, że <code>GET</code> to metoda, <em>/</em> to URI żądania, a <code>HTTP/1.1</code> to wersja.</p>
<p>Po linii żądania, pozostałe linie zaczynające się od <code>Host:</code> to nagłówki. Żądania <code>GET</code> nie mają ciała.</p>
<p>Spróbuj wysłać żądanie z innej przeglądarki lub poprosić o inny adres, na przykład <em>127.0.0.1:7878/test</em>, aby zobaczyć, jak zmieniają się dane żądania.</p>
<p>Teraz, gdy wiemy, o co prosi przeglądarka, wyślijmy z powrotem jakieś dane!</p>
<h3 id="pisanie-odpowiedzi"><a class="header" href="#pisanie-odpowiedzi">Pisanie odpowiedzi</a></h3>
<p>Zaimplementujemy wysyłanie danych w odpowiedzi na żądanie klienta. Odpowiedzi mają następujący format:</p>
<pre><code class="language-text">Wersja-HTTP Kod-statusu Fraza-powodowa CRLF
nagłówki CRLF
ciało-wiadomości
</code></pre>
<p>Pierwsza linia to <em>linia statusu</em>, która zawiera wersję HTTP używaną w odpowiedzi, numeryczny kod statusu, który podsumowuje wynik żądania, oraz frazę powodową, która zawiera tekstowy opis kodu statusu. Po sekwencji CRLF następują nagłówki, kolejna sekwencja CRLF i treść odpowiedzi.</p>
<p>Poniżej znajduje się przykładowa odpowiedź, która używa protokołu HTTP w wersji 1.1 i ma kod statusu 200, frazę „OK”, brak nagłówków i brak treści:</p>
<pre><code class="language-text">HTTP/1.1 200 OK\r\n\r\n
</code></pre>
<p>Kod statusu 200 to standardowa odpowiedź sukcesu. Tekst to mała, udana odpowiedź HTTP. Zapiszmy to do strumienia jako naszą odpowiedź na udane żądanie! Z funkcji <code>handle_connection</code> usuń <code>println!</code>, które drukowało dane żądania, i zastąp je kodem z Listingu 21-3.</p>
<listing number="21-3" file-name="src/main.rs" caption="Zapisywanie krótkiej, udanej odpowiedzi HTTP do strumienia">
<pre class="playground"><code class="language-rust no_run edition2024"><span class="boring">use std::{
</span><span class="boring">    io::{BufReader, prelude::*},
</span><span class="boring">    net::{TcpListener, TcpStream},
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
</span><span class="boring">
</span><span class="boring">    for stream in listener.incoming() {
</span><span class="boring">        let stream = stream.unwrap();
</span><span class="boring">
</span><span class="boring">        handle_connection(stream);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>fn handle_connection(mut stream: TcpStream) {
    let buf_reader = BufReader::new(&amp;stream);
    let http_request: Vec&lt;_&gt; = buf_reader
        .lines()
        .map(|result| result.unwrap())
        .take_while(|line| !line.is_empty())
        .collect();

    let response = "HTTP/1.1 200 OK\r\n\r\n";

    stream.write_all(response.as_bytes()).unwrap();
}</code></pre>
</listing>
<p>Pierwsza nowa linia definiuje zmienną <code>response</code>, która przechowuje dane wiadomości o sukcesie. Następnie wywołujemy <code>as_bytes</code> na naszym <code>response</code>, aby przekonwertować dane ciągu na bajty. Metoda <code>write_all</code> na <code>stream</code> przyjmuje <code>&amp;[u8]</code> i wysyła te bajty bezpośrednio przez połączenie. Ponieważ operacja <code>write_all</code> może zakończyć się niepowodzeniem, używamy <code>unwrap</code> dla każdego wyniku błędu, tak jak poprzednio. Ponownie, w prawdziwej aplikacji, należałoby tutaj dodać obsługę błędów.</p>
<p>Dzięki tym zmianom, uruchommy nasz kod i wyślijmy żądanie. Nie drukujemy już żadnych danych do terminala, więc nie zobaczymy żadnego wyniku poza danymi z Cargo. Gdy załadujesz <em>127.0.0.1:7878</em> w przeglądarce internetowej, powinieneś otrzymać pustą stronę zamiast błędu. Właśnie ręcznie zakodowałeś odbieranie żądania HTTP i wysyłanie odpowiedzi!</p>
<h3 id="zwracanie-prawdziwego-kodu-html"><a class="header" href="#zwracanie-prawdziwego-kodu-html">Zwracanie prawdziwego kodu HTML</a></h3>
<p>Zaimplementujmy funkcjonalność zwracania czegoś więcej niż pustej strony. Utwórz nowy plik <em>hello.html</em> w katalogu głównym swojego projektu, a nie w katalogu <em>src</em>. Możesz wpisać dowolny kod HTML; Listing 21-4 pokazuje jedną z możliwości.</p>
<listing number="21-4" file-name="hello.html" caption="Przykładowy plik HTML do zwrócenia w odpowiedzi">
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Witaj!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Witaj!&lt;/h1&gt;
    &lt;p&gt;Cześć z Rust&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
</listing>
<p>Jest to minimalny dokument HTML5 z nagłówkiem i tekstem. Aby zwrócić go z serwera po otrzymaniu żądania, zmodyfikujemy <code>handle_connection</code>, jak pokazano na Listingu 21-5, aby odczytać plik HTML, dodać go do odpowiedzi jako ciało i wysłać.</p>
<listing number="21-5" file-name="src/main.rs" caption="Wysyłanie zawartości *hello.html* jako treści odpowiedzi">
<pre class="playground"><code class="language-rust no_run edition2024">use std::{
    fs,
    io::{BufReader, prelude::*},
    net::{TcpListener, TcpStream},
};
// --snip--

<span class="boring">fn main() {
</span><span class="boring">    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
</span><span class="boring">
</span><span class="boring">    for stream in listener.incoming() {
</span><span class="boring">        let stream = stream.unwrap();
</span><span class="boring">
</span><span class="boring">        handle_connection(stream);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>fn handle_connection(mut stream: TcpStream) {
    let buf_reader = BufReader::new(&amp;stream);
    let http_request: Vec&lt;_&gt; = buf_reader
        .lines()
        .map(|result| result.unwrap())
        .take_while(|line| !line.is_empty())
        .collect();

    let status_line = "HTTP/1.1 200 OK";
    let contents = fs::read_to_string("hello.html").unwrap();
    let length = contents.len();

    let response =
        format!("{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}");

    stream.write_all(response.as_bytes()).unwrap();
}</code></pre>
</listing>
<p>Dodaliśmy <code>fs</code> do instrukcji <code>use</code>, aby wprowadzić moduł systemu plików biblioteki standardowej do zakresu. Kod do odczytywania zawartości pliku do ciągu znaków powinien wyglądać znajomo; użyliśmy go, gdy czytaliśmy zawartość pliku dla naszego projektu I/O w Listingu 12-4.</p>
<p>Następnie używamy <code>format!</code> do dodania zawartości pliku jako treści odpowiedzi sukcesu. Aby zapewnić prawidłową odpowiedź HTTP, dodajemy nagłówek <code>Content-Length</code>, który jest ustawiony na rozmiar naszej treści odpowiedzi – w tym przypadku, rozmiar <code>hello.html</code>.</p>
<p>Uruchom ten kod za pomocą <code>cargo run</code> i załaduj <em>127.0.0.1:7878</em> w swojej przeglądarce; powinieneś zobaczyć wyrenderowany HTML!</p>
<p>Obecnie ignorujemy dane żądania w <code>http_request</code> i po prostu bezwarunkowo wysyłamy z powrotem zawartość pliku HTML. Oznacza to, że jeśli spróbujesz zażądać <em>127.0.0.1:7878/cos-innego</em> w przeglądarce, nadal otrzymasz tę samą odpowiedź HTML. W tej chwili nasz serwer jest bardzo ograniczony i nie robi tego, co robi większość serwerów WWW. Chcemy dostosować nasze odpowiedzi w zależności od żądania i wysyłać plik HTML tylko dla dobrze sformułowanego żądania do <em>/</em>.</p>
<h3 id="walidacja-żądania-i-selektywne-odpowiadanie"><a class="header" href="#walidacja-żądania-i-selektywne-odpowiadanie">Walidacja żądania i selektywne odpowiadanie</a></h3>
<p>W tej chwili nasz serwer WWW zwróci HTML w pliku niezależnie od tego, co klient zażądał. Dodajmy funkcjonalność, aby sprawdzić, czy przeglądarka żąda <em>/</em> przed zwróceniem pliku HTML i aby zwrócić błąd, jeśli przeglądarka zażąda czegoś innego. W tym celu musimy zmodyfikować <code>handle_connection</code>, jak pokazano na Listingu 21-6. Ten nowy kod sprawdza zawartość otrzymanego żądania w porównaniu z tym, jak wygląda żądanie do <em>/</em>, i dodaje bloki <code>if</code> i <code>else</code>, aby traktować żądania inaczej.</p>
<listing number="21-6" file-name="src/main.rs" caption="Obsługa żądań do */* inaczej niż innych żądań">
<pre class="playground"><code class="language-rust no_run edition2024"><span class="boring">use std::{
</span><span class="boring">    fs,
</span><span class="boring">    io::{BufReader, prelude::*},
</span><span class="boring">    net::{TcpListener, TcpStream},
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
</span><span class="boring">
</span><span class="boring">    for stream in listener.incoming() {
</span><span class="boring">        let stream = stream.unwrap();
</span><span class="boring">
</span><span class="boring">        handle_connection(stream);
</span><span class="boring">    }
</span><span class="boring">}
</span>// --snip--

fn handle_connection(mut stream: TcpStream) {
    let buf_reader = BufReader::new(&amp;stream);
    let request_line = buf_reader.lines().next().unwrap().unwrap();

    if request_line == "GET / HTTP/1.1" {
        let status_line = "HTTP/1.1 200 OK";
        let contents = fs::read_to_string("hello.html").unwrap();
        let length = contents.len();

        let response = format!(
            "{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}"
        );

        stream.write_all(response.as_bytes()).unwrap();
    } else {
        // inne żądanie
    }
}</code></pre>
</listing>
<p>Będziemy tylko patrzeć na pierwszą linię żądania HTTP, więc zamiast odczytywać całe żądanie do wektora, wywołujemy <code>next</code>, aby pobrać pierwszy element z iteratora. Pierwszy <code>unwrap</code> zajmuje się <code>Option</code> i zatrzymuje program, jeśli iterator nie ma żadnych elementów. Drugi <code>unwrap</code> obsługuje <code>Result</code> i ma taki sam efekt jak <code>unwrap</code>, który został dodany w <code>map</code> w Listingu 21-2.</p>
<p>Następnie sprawdzamy <code>request_line</code>, aby zobaczyć, czy jest równa linii żądania GET do ścieżki <em>/</em>. Jeśli tak, blok <code>if</code> zwraca zawartość naszego pliku HTML.</p>
<p>Jeśli <code>request_line</code> <em>nie</em> jest równe żądaniu GET do ścieżki <em>/</em>, oznacza to, że otrzymaliśmy jakieś inne żądanie. Za chwilę dodamy kod do bloku <code>else</code>, aby odpowiedzieć na wszystkie inne żądania.</p>
<p>Uruchom ten kod teraz i zażądaj <em>127.0.0.1:7878</em>; powinieneś otrzymać HTML z <em>hello.html</em>. Jeśli wyślesz jakiekolwiek inne żądanie, takie jak <em>127.0.0.1:7878/cos-innego</em>, otrzymasz błąd połączenia, podobny do tych, które widziałeś, uruchamiając kod z Listingu 21-1 i Listingu 21-2.</p>
<p>Teraz dodajmy kod z Listingu 21-7 do bloku <code>else</code>, aby zwrócić odpowiedź z kodem statusu 404, który sygnalizuje, że zawartość dla żądania nie została znaleziona. Zwrócimy również kod HTML dla strony, aby przeglądarka mogła ją wyrenderować, wskazując odpowiedź użytkownikowi końcowemu.</p>
<listing number="21-7" file-name="src/main.rs" caption="Odpowiedź z kodem statusu 404 i stroną błędu, jeśli zażądano czegoś innego niż */*">
<pre class="playground"><code class="language-rust no_run edition2024"><span class="boring">use std::{
</span><span class="boring">    fs,
</span><span class="boring">    io::{BufReader, prelude::*},
</span><span class="boring">    net::{TcpListener, TcpStream},
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
</span><span class="boring">
</span><span class="boring">    for stream in listener.incoming() {
</span><span class="boring">        let stream = stream.unwrap();
</span><span class="boring">
</span><span class="boring">        handle_connection(stream);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn handle_connection(mut stream: TcpStream) {
</span><span class="boring">    let buf_reader = BufReader::new(&amp;stream);
</span><span class="boring">    let request_line = buf_reader.lines().next().unwrap().unwrap();
</span><span class="boring">
</span><span class="boring">    if request_line == "GET / HTTP/1.1" {
</span><span class="boring">        let status_line = "HTTP/1.1 200 OK";
</span><span class="boring">        let contents = fs::read_to_string("hello.html").unwrap();
</span><span class="boring">        let length = contents.len();
</span><span class="boring">
</span><span class="boring">        let response = format!(
</span><span class="boring">            "{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}"
</span><span class="boring">        );
</span><span class="boring">
</span><span class="boring">        stream.write_all(response.as_bytes()).unwrap();
</span>    // --snip--
    } else {
        let status_line = "HTTP/1.1 404 NOT FOUND";
        let contents = fs::read_to_string("404.html").unwrap();
        let length = contents.len();

        let response = format!(
            "{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}"
        );

        stream.write_all(response.as_bytes()).unwrap();
    }
<span class="boring">}</span></code></pre>
</listing>
<p>Tutaj nasza odpowiedź zawiera linię statusu z kodem statusu 404 i frazą powodu <code>NOT FOUND</code>. Ciałem odpowiedzi będzie HTML z pliku <em>404.html</em>. Będziesz musiał utworzyć plik <em>404.html</em> obok <em>hello.html</em> dla strony błędu; ponownie, możesz użyć dowolnego kodu HTML, jaki chcesz, lub użyć przykładowego kodu HTML z Listingu 21-8.</p>
<listing number="21-8" file-name="404.html" caption="Przykładowa zawartość strony do odesłania z dowolną odpowiedzią 404">
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Witaj!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Ups!&lt;/h1&gt;
    &lt;p&gt;Przepraszam, nie wiem, o co prosisz.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
</listing>
<p>Dzięki tym zmianom uruchom ponownie swój serwer. Żądanie <em>127.0.0.1:7878</em> powinno zwrócić zawartość pliku <em>hello.html</em>, a każde inne żądanie, takie jak <em>127.0.0.1:7878/foo</em>, powinno zwrócić kod HTML błędu z <em>404.html</em>.</p>
<!-- Old headings. Do not remove or links may break. -->
<p><a id="a-touch-of-refactoring"></a></p>
<h3 id="refaktoryzacja"><a class="header" href="#refaktoryzacja">Refaktoryzacja</a></h3>
<p>W tej chwili bloki <code>if</code> i <code>else</code> mają wiele powtórzeń: oba odczytują pliki i zapisują zawartość plików do strumienia. Jedyne różnice to linia statusu i nazwa pliku. Uczyńmy kod bardziej zwięzłym, wyodrębniając te różnice w osobne linie <code>if</code> i <code>else</code>, które przypiszą wartości linii statusu i nazwy pliku do zmiennych; możemy następnie użyć tych zmiennych bezwarunkowo w kodzie do odczytu pliku i zapisu odpowiedzi. Listing 21-9 pokazuje wynikowy kod po zastąpieniu dużych bloków <code>if</code> i <code>else</code>.</p>
<listing number="21-9" file-name="src/main.rs" caption="Refaktoryzacja bloków `if` i `else`, aby zawierały tylko kod, który różni się między dwoma przypadkami">
<pre class="playground"><code class="language-rust no_run edition2024"><span class="boring">use std::{
</span><span class="boring">    fs,
</span><span class="boring">    io::{BufReader, prelude::*},
</span><span class="boring">    net::{TcpListener, TcpStream},
</span><span class="boring">};
</span><span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
</span><span class="boring">
</span><span class="boring">    for stream in listener.incoming() {
</span><span class="boring">        let stream = stream.unwrap();
</span><span class="boring">
</span><span class="boring">        handle_connection(stream);
</span><span class="boring">    }
</span><span class="boring">}
</span>// --snip--

fn handle_connection(mut stream: TcpStream) {
    // --snip--
<span class="boring">    let buf_reader = BufReader::new(&amp;stream);
</span><span class="boring">    let request_line = buf_reader.lines().next().unwrap().unwrap();
</span>
    let (status_line, filename) = if request_line == "GET / HTTP/1.1" {
        ("HTTP/1.1 200 OK", "hello.html")
    } else {
        ("HTTP/1.1 404 NOT FOUND", "404.html")
    };

    let contents = fs::read_to_string(filename).unwrap();
    let length = contents.len();

    let response =
        format!("{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}");

    stream.write_all(response.as_bytes()).unwrap();
}</code></pre>
</listing>
<p>Teraz bloki <code>if</code> i <code>else</code> zwracają tylko odpowiednie wartości dla linii statusu i nazwy pliku w krotce; następnie używamy dekompozycji do przypisania tych dwóch wartości do <code>status_line</code> i <code>filename</code> za pomocą wzorca w instrukcji <code>let</code>, jak omówiono w Rozdziale 19.</p>
<p>Poprzednio zduplikowany kod znajduje się teraz poza blokami <code>if</code> i <code>else</code> i używa zmiennych <code>status_line</code> i <code>filename</code>. Ułatwia to dostrzeżenie różnicy między dwoma przypadkami, a także oznacza, że mamy tylko jedno miejsce do aktualizacji kodu, jeśli chcemy zmienić sposób działania odczytu plików i zapisu odpowiedzi. Zachowanie kodu z Listingu 21-9 będzie takie samo jak z Listingu 21-7.</p>
<p>Świetnie! Mamy teraz prosty serwer WWW w około 40 liniach kodu Rust, który odpowiada na jedno żądanie stroną treści i na wszystkie inne żądania odpowiedzią 404.</p>
<p>Obecnie nasz serwer działa w jednym wątku, co oznacza, że może obsługiwać tylko jedno żądanie na raz. Zbadajmy, jak to może być problemem, symulując kilka wolnych żądań. Następnie naprawimy to, aby nasz serwer mógł obsługiwać wiele żądań jednocześnie.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch21-00-final-project-a-web-server.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="ch21-02-multithreaded.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch21-00-final-project-a-web-server.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="ch21-02-multithreaded.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="ferris-2317480c.js"></script>



    </div>
    </body>
</html>
